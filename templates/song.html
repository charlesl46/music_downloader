<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css">
        <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js"></script>
    </head>
    <body>
        <div class="ui left fixed vertical menu">
            <div class="item">
                <img class="ui small image" src="{{ url_for('static', filename='img/logo.png') }}">
            </div>
            <a href="/song" class="item">Download a song</a>
            <a href="/album" class="item">Download an album</a>
            <a href="/history" class="item">History</a>
        </div>
        <div style="margin-top: 10px;" class="ui container">
            <div class="ui segment">
                <h1 class="ui header">Download a song</h1>
                <div class="ui massive fluid search">
                    <div class="ui icon input">
                      <input class="prompt" type="text" placeholder="Ex : Thriller by MJ">
                      <i class="search icon"></i>
                    </div>
                    <div class="results transition"></div>
                </div>
                <div class="ui blue indeterminate large progress">
                    <div class="bar">
                        <div id="progress_text" class="progress"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();

        socket.on('download_progress', function(data) {
            console.log('Download Progress:', data.progress);
            $("#progress_text").text(data.progress);
        });

        document.addEventListener("DOMContentLoaded",()=>{
            $(".progress").hide();
        })

        function downloadSong(title) {
            $(".results").removeClass("visible");
            $(".search").hide();
            $(".progress").show();
            $("#progress_text").text("Téléchargement démarré");
            $.ajax({
                url: "/download_song",
                type: "POST",
                contentType: "application/json;charset=UTF-8",
                data: JSON.stringify({ title: title }),
                dataType: "json",
                success: function(response) {
                    $(".progress").hide();
                    $.toast({
                        displayTime: 10000,
                        showImage : response.cover_path,
                        classImage : 'tiny',
                        title: 'Téléchargement terminé',
                        message: response.title_downloaded
                    });
                    $(".search").show();
                },
                error: function(error) {
                    console.error(error);
                }
            });
        }

        $("input").keyup(function(){
            var value = $(this).val().toString();
            if (value == ""){
                $(".results").removeClass("visible");
            }
            else{
                $(".results").addClass("visible");
                $.ajax({
                    url: "/suggest_song",
                    type: "POST",
                    contentType: "application/json;charset=UTF-8",
                    data: JSON.stringify({ title: value }),
                    dataType: "json",
                    success: function(response) {
                        if (response.suggestion){
                            $(".results").html(`<div class="result result-link"> <img class="ui small image" src="${response.cover_path}"> ${response.suggestion}</div>`);
                        }
                    },
                    error: function(error) {
                        console.error(error);
                    }
                });
            }
        });

        $(".results").on("click", ".result-link", function(){
            var song = $(this).text().toString();
            console.log(song);
            downloadSong(song);
        });

        $(".prompt").keydown(function(event){
            if (event.key === "Enter"){
                var song = $(this).val().toString();
                console.log(song);
                downloadSong(song);
            }
        });
    </script>
</html>
